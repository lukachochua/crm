  - php artisan db:seed --class=RolesAndPermissionsSeeder (creates roles/permissions)
  - php artisan make:filament-user (creates a user, no roles assigned)
  - php artisan tinker then:
      - $user->assignRole('Admin')
      - $user->syncRoles(['Admin'])
      - $user->givePermissionTo('orders.view')
      - $user->syncPermissions([...])
      - $user->removeRole('Sales'), $user->revokePermissionTo('orders.view')
  - php artisan permission:cache-reset (if permissions seem stale)
• User Guide

  Access & Setup

  - Install deps: composer install
  - Configure DB in .env (MySQL defaults set to crm)
  - Run migrations: php artisan migrate
  - Seed roles/permissions: php artisan db:seed
  - Create a Filament user: php artisan make:filament-user
  - Assign a role in Tinker:

    $user = \App\Models\User::where('email', 'you@example.com')->first();
    $user->assignRole('Admin'); // or Sales, Back Office, Finance, Turnover
  - Log in at /admin

  Roles & Permissions (Exact Matrix)

  - Sales: full on Applications, Orders, Reservations, Customers, Vehicles; view only
    Invoices
  - Back Office: view Applications; full Orders, Reservations, Customers, Vehicles,
    Invoices; view Payments
  - Finance: view Orders, Customers, Turnover; full Invoices, Payments
  - Turnover: view Invoices; full Turnover overview
  - Admin: full access everywhere

  Navigation & Visibility

  - Navigation links appear only if your role can view that module
  - Create/Edit/Delete actions appear only with the matching permissions
  - Export buttons appear only if your role has export on that module

  Modules & How to Use Them

  1. Applications / Requests

  - Purpose: capture initial customer intent
  - Required: Customer, Status, Requested At
  - Optional: Description, Source (walk-in/phone/online), Internal Notes
  - Access: Sales/Admin full; Back Office view-only
  - Notes: status changes are validated (see “Status Transitions”)

  2. Orders

  - Purpose: confirmed commercial agreement
  - Required: Customer, Order Number, Status, Total Amount
  - Optional: Application link, Discount Amount, Notes
  - Access: Sales/Back Office/Admin full; Finance view-only
  - Relations: Orders appear under each Customer; Invoices under each Order

  3. Reservations

  - Purpose: asset allocation to an order
  - Required: Order, Vehicle, Status, Reserved From/Until
  - Optional: Notes
  - Access: Sales/Back Office/Admin full
  - Notes: status transitions enforced

  4. Customers

  - Purpose: canonical client record
  - Required: First Name, Last Name, Personal ID/Tax ID, Phone
  - Optional: Email, Address, Notes
  - Access: Sales/Back Office/Admin full; Finance view-only
  - Relation: shows Orders relation manager

  5. Vehicles / Assets

  - Purpose: sellable/reservable asset
  - Required: VIN/Serial, Type, Status (available/reserved/sold)
  - Optional: Model, Year, Color, Notes
  - Access: Sales/Back Office/Admin full

  6. Invoices

  - Purpose: formal financial document for an order
  - Required: Order, Invoice Number, Status, Total Amount, Issued At
  - Optional: Due Date, Notes
  - Access: Back Office/Finance/Admin full; Sales/Turnover view-only
  - Notes: invoice status transitions enforced; financial actions audited

  7. Payments

  - Purpose: actual money movement
  - Required: Invoice, Amount, Status, Payment Date
  - Optional: Payment Method (cash/card/transfer), Reference Number, Notes
  - Access: Finance/Admin full; Back Office view-only
  - Notes: payment status transitions enforced; financial actions audited

  8. Turnover / Revenue Overview

  - Purpose: monthly rollup of invoiced/paid/outstanding
  - Read-only view derived from invoices + payments
  - Access: Turnover/Admin full; Finance view-only
  - No create/edit/delete

  Status Transitions (Strict)

  - Applications: new → reviewed → approved → converted; reviewed → rejected
  - Orders: draft → confirmed → completed | cancelled
  - Reservations: active → fulfilled | expired | cancelled
  - Invoices: draft → issued → partially_paid | paid | cancelled; partially_paid → paid
  - Payments: pending → completed | failed; completed → reversed
    Invalid transitions are blocked on save.

  Audit Logs

  - Automatically recorded in audit_logs for:
      - status changes
      - financial actions (payment create/complete/reverse, invoice cancel/amount change)
      - deletions (soft deletes)
  - Logs are immutable and never deleted
  - No Filament UI is provided for audit logs yet (database only)

  Deletions

  - Applications, Orders, Reservations, Customers, Vehicles, Invoices, Payments use soft
    deletes
  - Audit logs and Turnover view are not soft-deleted
  - Restore UI is not implemented

  If you want, I can add a Filament “Audit Logs” read-only resource, or provide a quick
  role-assignment artisan command per user.

____________________________________________

• Implementation is already in place per the approved spec. Here are the deliverables and
  where they live:

  Structure

  - Core domains: app/Models, app/Enums, app/Policies, app/Observers, app/Services
  - Filament UI: app/Filament/Resources
  - Database: database/migrations, database/seeders
  - Spec + setup: docs/CRM.md

  Migrations

  - Core entities: database/migrations/2025_12_19_190900_create_customers_table.php,
    database/migrations/2025_12_19_190905_create_vehicles_table.php, database/
    migrations/2025_12_19_190910_create_applications_table.php, database/
    migrations/2025_12_19_190915_create_orders_table.php, database/
    migrations/2025_12_19_190920_create_reservations_table.php, database/
    migrations/2025_12_19_190925_create_invoices_table.php, database/
    migrations/2025_12_19_190930_create_payments_table.php
  - Audit logs: database/migrations/2025_12_19_190940_create_audit_logs_table.php
  - Turnover view: database/
    migrations/2025_12_19_191200_create_turnover_overviews_view.php
  - Spatie permissions: database/
    migrations/2025_12_19_190512_create_permission_tables.php

  Models

  - Business entities: app/Models/Application.php, app/Models/Order.php, app/Models/
    Reservation.php, app/Models/Customer.php, app/Models/Vehicle.php, app/Models/
    Invoice.php, app/Models/Payment.php
  - Support: app/Models/AuditLog.php, app/Models/TurnoverOverview.php

  Enums

  - Status + audit enums: app/Enums/ApplicationStatus.php, app/Enums/OrderStatus.php,
    app/Enums/ReservationStatus.php, app/Enums/InvoiceStatus.php, app/Enums/
    PaymentStatus.php, app/Enums/AuditActionType.php

  Policies

  - Access control: app/Policies/ApplicationPolicy.php, app/Policies/OrderPolicy.php,
    app/Policies/ReservationPolicy.php, app/Policies/CustomerPolicy.php, app/Policies/
    VehiclePolicy.php, app/Policies/InvoicePolicy.php, app/Policies/PaymentPolicy.php,
    app/Policies/TurnoverOverviewPolicy.php

  Seeders

  - Roles + permissions: database/seeders/RolesAndPermissionsSeeder.php, database/
    seeders/DatabaseSeeder.php
  - Permission helper: app/Support/Permissions.php

  Filament Resources

  - Resources: app/Filament/Resources/ApplicationResource.php, app/Filament/Resources/
    OrderResource.php, app/Filament/Resources/ReservationResource.php, app/Filament/
    Resources/CustomerResource.php, app/Filament/Resources/VehicleResource.php, app/
    Filament/Resources/InvoiceResource.php, app/Filament/Resources/PaymentResource.php,
    app/Filament/Resources/TurnoverOverviewResource.php
  - Relation managers: app/Filament/Resources/CustomerResource/RelationManagers/
    OrdersRelationManager.php, app/Filament/Resources/OrderResource/RelationManagers/
    InvoicesRelationManager.php

  Setup

  - Steps are documented in docs/CRM.md (migrate, seed roles/permissions, create Filament
    user).

• Full manual test flow (Admin role)

  1. Log in to Filament at /admin using a user that has the Admin role (seeded by
     database/seeders/RolesAndPermissionsSeeder.php).
  2. Create a customer: Clients & Assets → Customers → Create. Fill first_name,
     last_name, personal_id_or_tax_id, phone. Save.
  3. Create a Vehicle. 
  4. Create an application: Sales → Applications → Create. Select the customer, set
     status = new, set requested_at. Save.
  5. Verify application transitions: Edit the application and move new → reviewed →
     approved → converted. Try an invalid jump (e.g., new → approved) and confirm it is
     blocked.
  6. Create an order: Sales → Orders → Create. Select customer, optionally link the
     application, set order_number, status = draft, total_amount. Save.
  7. Verify order transitions: Edit and move draft → confirmed → completed (or draft →
     confirmed → cancelled). Invalid transitions should be blocked.
  8. Create a reservation: Sales → Reservations → Create. Select the order and vehicle,
     set status = active, set reserved_from/reserved_until. Save.
  9. Verify reservation transitions: Edit and move active → fulfilled (or expired/
     cancelled). Invalid transitions should be blocked.
  10. Create an invoice: Invoicing → Invoices → Create. Select order, set invoice_number,
     status = draft, total_amount, issued_at. Save.
  11. Verify invoice transitions: Edit and move draft → issued → partially_paid → paid
     (or issued → cancelled). Invalid transitions should be blocked.
     pending, payment_date, payment_method. Save.
  13. Verify payment transitions: Edit and move pending → completed (optional completed →
     reversed). Invalid transitions should be blocked.
  14. Turnover overview: Turnover → Turnover Overview. Confirm the period row shows the
     invoice total and payment total for the month.

  Optional checks

  - Audit logs (status changes, payments, deletions): query audit_logs in the DB to
    confirm entries for status changes, payment creation/status changes, and deletions.
  - Role-based access: sign in as each role and confirm navigation hides “no access”
    entities and disables actions for “view-only” (e.g., Sales can only view invoices,
    Finance can only view orders/customers).

  If you want, I can add a quick test checklist by role (Sales/Back Office/Finance/
// FULL MANUAL CHECK

Here’s the full manual again plus role assignment via Tinker and the key dev/superadmin
  commands.

  ———

  Role Assignment (Tinker + Commands)

  Seed roles/permissions (required once)

  php artisan db:seed --class=RolesAndPermissionsSeeder

  Create a Filament user (admin UI login)

  php artisan make:filament-user

  Assign roles via Tinker

  php artisan tinker

  use App\Models\User;

  // by email
  $user = User::where('email', 'sales@example.com')->firstOrFail();

  // assign a single role
  $user->assignRole('Sales');

  // replace all roles with one or more
  $user->syncRoles(['Finance']);     // or ['Admin', 'Turnover']

  // check roles
  $user->getRoleNames();

  Reset permission cache (if role changes don’t apply)

  php artisan permission:cache-reset

  ———

  Dev/Superadmin Commands You’ll Actually Use

  - Migrate database:

    php artisan migrate
  - Seed roles/permissions:

    php artisan db:seed --class=RolesAndPermissionsSeeder
  - Create admin user:

    php artisan make:filament-user
  - Clear config after .env changes:

    php artisan config:clear
  - Clear application cache:

    php artisan cache:clear
  - Run queue worker (exports & notifications):

    php artisan queue:work
    Or set QUEUE_CONNECTION=sync for dev-only synchronous exports.

  ———

  # FULL USER MANUAL (BY ROLE)

  General (All Roles)

  - Log in at /admin.
  - Search, sort, and filter in list pages.
  - Status badges show state and color.
  - Invalid status transitions are blocked with a message.
  - Exports appear only when your role has full access to that module.
  - After create, you land on edit (not read-only).

  ———

  ## Sales

  Access

  - Applications: full
  - Orders: full
  - Reservations: full
  - Customers: full
  - Vehicles: full
  - Invoices: view-only

  Workflow

  1. Customers → Create
  2. Vehicles → Create
  3. Applications → Create
      - Status flow: new → reviewed → approved → converted or reviewed → rejected
  4. Orders → Create (link Customer, optional Application)
      - Status flow: draft → confirmed → completed or draft → confirmed → cancelled
  5. Reservations → Create (link Order + Vehicle)
      - Status flow: active → fulfilled|expired|cancelled
  6. Invoices: view only

  ———

  ## Back Office

  Access

  - Applications: view-only
  - Orders: full
  - Reservations: full
  - Customers: full
  - Vehicles: full
  - Invoices: full
  - Payments: view-only

  Workflow

  - Same as Sales for Orders/Reservations/Customers/Vehicles.
  - Invoices: create + update + delete + export.
  - Payments: view only.

  ———

  ## Finance

  Access

  - Orders: view-only
  - Customers: view-only
  - Invoices: full
  - Payments: full
  - Turnover overview: view-only

  Workflow

  1. Invoices → Create/Edit
      - Status flow: draft → issued → partially_paid → paid or issued → cancelled
  2. Payments → Create/Edit
      - Status flow: pending → completed → reversed or pending → failed
  3. Turnover overview: view only

  ———

  ## Turnover

  Access

  - Turnover overview: full
  - Invoices: view-only

  Workflow

  - Turnover overview → view + export
  - Invoices: view only

  ———

  ## Admin

  Access

  - Full access to everything.

  Workflow

  - Same as all roles combined.

  ______________________________________________________
   Business flow (real‑world meaning)

  - Customer: the person or organization you do business with.
  - Application: the customer’s request/lead/intake — “I want to buy/rent/request this.”
    It’s the initial intake record, used by Sales to qualify and move through statuses
    (new → reviewed → approved → converted or rejected).
  - Order: the commercial commitment — “we are proceeding with this deal.” It represents
    the actual transaction details, totals, and status (draft → confirmed → completed or
    cancelled).
  - Reservation: allocates a vehicle/asset to an order for a time period. This is
    operationally “this car/asset is held for that order.”
  - Invoice: the billing document tied to an order. It has its own lifecycle (draft →
    issued → partially_paid → paid or cancelled).
  - Payment: actual money movement tied to an invoice, with its own status (pending →
    completed → reversed or failed).
  - Turnover overview: read‑only financial summary by period, derived from invoices and
    payments.

  About amounts/price linkage

  - The spec doesn’t require automatic price linkage across models.
    Today:
      - orders.total_amount is independent.
      - invoices.total_amount is independent.
      - payments.amount is independent.
  - That allows real‑world scenarios like partial invoicing, discounts, write‑offs, and
    partial payments. If you want strict enforcement (e.g., invoice total must equal
    order total, or payments must sum to invoice), that’s not in the current spec and
    would be a design change—happy to add it if you explicitly want to change the rules.

  Reminder: PDF/screenshot manual

